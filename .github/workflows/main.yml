name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron:  '0 0 * * *'    # At every 15th minute
env:
  APP_URL: 'https://your-app-url.com'  # Replace with your actual app URL
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      run: npx playwright test
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: test-results/report/
        retention-days: 30
    # Parse test results and calculate health stats
    - name: Parse test results
      if: always()
      id: test-stats
      run: |
        results=$(cat test-results/results/results.json)
        stats=$(echo $results | jq .stats)
        total=$(echo $stats | jq '.expected + .unexpected + .skipped + .flaky')
        pass=$(echo $stats | jq '.expected')
        fail=$(echo $stats | jq '.unexpected')
        skip=$(echo $stats | jq '.skipped')
        flaky=$(echo $stats | jq '.flaky')
        health=$((pass * 100 / total))
        echo "health=$health" >> $GITHUB_ENV
        echo "pass=$pass" >> $GITHUB_ENV
        echo "fail=$fail" >> $GITHUB_ENV
        echo "skip=$skip" >> $GITHUB_ENV
        echo "flaky=$flaky" >> $GITHUB_ENV
    # Send Slack notificationn
    - name: Send Slack notification
      if: always()
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      with:
        status: "success"   # or dynamically set based on the job outcome
        text: "*PLAYWRIGHT TEST SUMMARY* - Health: ${{ env.health }}%
          Total: ${{ env.pass + env.fail + env.skip + env.flaky }} | Failures: ${{ env.fail }} | Skipped: ${{ env.skip }} | Flaky: ${{ env.flaky }} | Passed: ${{ env.pass }}"